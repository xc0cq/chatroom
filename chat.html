<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Chat Room</title>
  <style>
    body {
      background: linear-gradient(135deg, #000000, #8304e0);
      font-family: Arial, sans-serif;
      color: white;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #onlineUsers {
      background: #1a1a1a;
      padding: 6px 12px;
      font-size: 0.9em;
      border-bottom: 1px solid #444;
      display: flex;
      gap: 10px;
      align-items: center;
      overflow-x: auto;
      white-space: nowrap;
    }
    #onlineUsers span {
      background: #8304e0aa;
      border-radius: 12px;
      padding: 2px 10px;
      user-select: none;
      font-weight: bold;
    }
    #messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: rgba(0,0,0,0.2);
    }
    .message {
      margin: 5px 0;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .message .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .message .username {
      font-weight: bold;
      cursor: default;
    }
    .message .timestamp {
      font-size: 0.75em;
      color: #bbb;
      margin-left: 8px;
      white-space: nowrap;
    }
    .message .actions {
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
      flex-wrap: wrap;
    }
    .message:hover .actions {
      opacity: 1;
    }
    .message .actions button {
      background: transparent;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 14px;
    }
    .message .reply-quote {
      font-size: 0.9em;
      color: #aaa;
      border-left: 3px solid #8304e0;
      padding-left: 8px;
      margin-bottom: 5px;
      font-style: italic;
    }
    .message .text {
      margin-top: 4px;
      white-space: pre-wrap;
      word-break: break-word;
      cursor: default;
    }
    .message .edited {
      font-size: 0.75em;
      color: #888;
      margin-left: 6px;
      font-style: italic;
    }
    .reactions {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .reaction {
      background: #333333aa;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 4px;
      color: white;
      position: relative;
    }
    .reaction.self {
      background: #6b47ff;
    }
    .reaction .tooltip {
      visibility: hidden;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 4px 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
      font-size: 0.8em;
    }
    .reaction:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    #input-area {
      display: flex;
      padding: 10px;
      background: #1a1a1a;
      flex-wrap: wrap;
      align-items: center;
    }
    #replyingTo {
      flex-basis: 100%;
      margin-bottom: 6px;
      font-style: italic;
      color: #8304e0;
      user-select: none;
    }
    #typingIndicator {
      flex-basis: 100%;
      font-style: italic;
      color: #ccc;
      height: 20px;
      margin-left: 10px;
      min-height: 20px;
      user-select: none;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      outline: none;
      background: #2a2a2a;
      color: white;
      resize: none;
      min-height: 40px;
    }
    #input-area button {
      margin-left: 10px;
      background: linear-gradient(90deg, #5302b8, #8304e0);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    #cancelEditBtn {
      background: #a83232 !important;
    }
    #historyModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 20px #8304e0cc;
      max-width: 90vw;
      max-height: 70vh;
      overflow-y: auto;
      display: none;
      z-index: 9999;
      color: white;
    }
    #historyModal h3 {
      margin-top: 0;
      color: #8304e0;
    }
    #historyModal button.close {
      position: absolute;
      top: 8px;
      right: 12px;
      background: transparent;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    #historyList {
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 50vh;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="onlineUsers">Online: <span id="onlineList">Loading...</span></div>
  <div id="messages"></div>
  <div id="input-area">
    <div id="replyingTo" style="display:none;"></div>
    <textarea id="messageInput" placeholder="Type a message..." rows="2"></textarea>
    <button id="sendBtn">Send</button>
    <button id="cancelEditBtn" style="display:none; margin-left:10px;">Cancel Edit</button>
    <div id="typingIndicator"></div>
  </div>

  <!-- Modal for edit history -->
  <div id="historyModal" role="dialog" aria-modal="true">
    <button class="close" title="Close">&times;</button>
    <h3>Edit History</h3>
    <div id="historyList"></div>
  </div>

  <!-- Firebase Compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-9Hk4TBPi4WLb4anO-84FDpIfjH8X8HY",
      authDomain: "chatting-f1958.firebaseapp.com",
      databaseURL: "https://chatting-f1958-default-rtdb.firebaseio.com",
      projectId: "chatting-f1958",
      storageBucket: "chatting-f1958.appspot.com",
      messagingSenderId: "308400029505",
      appId: "1:308400029505:web:a265599a58f1881e83abc0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const messagesRef = db.ref("messages");
    const typingRef = db.ref("typing");
    const presenceRef = db.ref("presence");

    const username = localStorage.getItem("chatUser");
    if (!username) {
      window.location.href = "index.html";
    }

    // Admin users - can delete any message
    const adminUsers = ["admin"];

    // Username gradients from before
    const userGradientClasses = {
      "justin": "gradient-rainbow",
      "mason": "gradient-goldblack",
    };

    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const replyingToDiv = document.getElementById("replyingTo");
    const typingIndicator = document.getElementById("typingIndicator");
    const onlineListSpan = document.getElementById("onlineList");

    // Modal for edit history
    const historyModal = document.getElementById("historyModal");
    const historyList = document.getElementById("historyList");
    const closeHistoryBtn = historyModal.querySelector("button.close");

    let editingMessageId = null;
    let replyingToMessage = null;
    let typingTimeout;

    // Update presence (online users)
    function setPresence() {
      const userPresenceRef = presenceRef.child(username);
      userPresenceRef.set(true);
      userPresenceRef.onDisconnect().remove();
    }
    setPresence();

    // Listen for presence changes
    presenceRef.on("value", snapshot => {
      const users = snapshot.val() || {};
      const onlineUsers = Object.keys(users);
      if (onlineUsers.length === 0) {
        onlineListSpan.textContent = "No one online";
      } else {
        onlineListSpan.innerHTML = onlineUsers.map(u => {
          const gradientClass = userGradientClasses[u.toLowerCase()] || "";
          return `<span class="${gradientClass}">${u}</span>`;
        }).join(", ");
      }
    });

    // Typing indicator
    messageInput.addEventListener("input", () => {
      typingRef.child(username).set(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        typingRef.child(username).remove();
      }, 1500);
    });

    typingRef.on("value", snapshot => {
      const typingUsers = snapshot.val() || {};
      const othersTyping = Object.keys(typingUsers).filter(u => u !== username);
      if (othersTyping.length === 0) {
        typingIndicator.textContent = "";
      } else if (othersTyping.length === 1) {
        typingIndicator.textContent = `${othersTyping[0]} is typing...`;
      } else {
        typingIndicator.textContent = "Multiple users are typing...";
      }
    });

    sendBtn.onclick = () => {
      const text = messageInput.value.trim();
      if (!text) return;

      if (editingMessageId) {
        // Save edit with history
        messagesRef.child(editingMessageId).once("value").then(snap => {
          const msg = snap.val();
          const history = msg.history || [];
          history.push({ text: msg.text, timestamp: msg.timestamp || Date.now() });
          messagesRef.child(editingMessageId).update({
            text: text,
            edited: true,
            history: history,
            timestamp: Date.now(),
            replyTo: replyingToMessage ? replyingToMessage.id : null
          });
          clearInputState();
        });
      } else {
        messagesRef.push({
          user: username,
          text: text,
          timestamp: Date.now(),
          replyTo: replyingToMessage ? replyingToMessage.id : null,
          reactions: {}
        });
        clearInputState();
      }
    };

    cancelEditBtn.onclick = clearInputState;

    function clearInputState() {
      editingMessageId = null;
      replyingToMessage = null;
      messageInput.value = "";
      sendBtn.textContent = "Send";
      cancelEditBtn.style.display = "none";
      replyingToDiv.style.display = "none";
      replyingToDiv.textContent = "";
    }

    const messageElements = {};

    function getGradientClass(user) {
      return userGradientClasses[user.toLowerCase()] || "";
    }

    function formatTimestamp(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function renderMessage(snapshot) {
      const msg = snapshot.val();
      msg.id = snapshot.key;

      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message");
      msgDiv.id = "msg-" + msg.id;

      if (msg.replyTo && messageElements[msg.replyTo]) {
        const replyMsg = messageElements[msg.replyTo].msgData;
        const replyQuote = document.createElement("div");
        replyQuote.className = "reply-quote";
        replyQuote.textContent = `↳ ${replyMsg.user}: ${replyMsg.text.length > 30 ? replyMsg.text.slice(0,30) + "..." : replyMsg.text}`;
        msgDiv.appendChild(replyQuote);
      }

      const topRow = document.createElement("div");
      topRow.className = "top-row";

      const userSpan = document.createElement("span");
      userSpan.textContent = msg.user;
      userSpan.classList.add("username");
      const gradientClass = getGradientClass(msg.user);
      if (gradientClass) userSpan.classList.add(gradientClass);
      topRow.appendChild(userSpan);

      const timeSpan = document.createElement("span");
      timeSpan.className = "timestamp";
      timeSpan.textContent = formatTimestamp(msg.timestamp);
      topRow.appendChild(timeSpan);

      msgDiv.appendChild(topRow);

      const textSpan = document.createElement("div");
      textSpan.className = "text";
      textSpan.textContent = msg.text;
      msgDiv.appendChild(textSpan);

      if (msg.edited) {
        const editedSpan = document.createElement("span");
        editedSpan.className = "edited";
        editedSpan.textContent = " (edited)";
        textSpan.appendChild(editedSpan);
      }

      // Reactions container
      const reactionsDiv = document.createElement("div");
      reactionsDiv.className = "reactions";

      const reactions = msg.reactions || {};
      for (const [emoji, users] of Object.entries(reactions)) {
        const count = Object.keys(users).length;
        const reactedByUser = !!users[username];

        const reactionBtn = document.createElement("div");
        reactionBtn.className = "reaction";
        if (reactedByUser) reactionBtn.classList.add("self");

        reactionBtn.textContent = `${emoji} ${count}`;

        // Tooltip with list of users who reacted
        const tooltip = document.createElement("span");
        tooltip.className = "tooltip";
        tooltip.textContent = Object.keys(users).join(", ");
        reactionBtn.appendChild(tooltip);

        reactionBtn.title = reactedByUser ? "Remove reaction" : "Add reaction";
        reactionBtn.onclick = () => toggleReaction(msg.id, emoji, reactedByUser);
        reactionsDiv.appendChild(reactionBtn);
      }

      // Add reaction button
      const addReactionBtn = document.createElement("div");
      addReactionBtn.className = "reaction";
      addReactionBtn.textContent = "+";
      addReactionBtn.title = "Add reaction";
      addReactionBtn.onclick = () => promptAddReaction(msg.id);
      reactionsDiv.appendChild(addReactionBtn);

      msgDiv.appendChild(reactionsDiv);

      // Actions (reply, edit, delete)
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "actions";

      // Reply button for all
      const replyBtn = document.createElement("button");
      replyBtn.textContent = "Reply";
      replyBtn.title = "Reply to message";
      replyBtn.onclick = () => startReplyMessage(msg);
      actionsDiv.appendChild(replyBtn);

      if (msg.user === username || adminUsers.includes(username.toLowerCase())) {
        // Edit button (only for own messages)
        if (msg.user === username) {
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.title = "Edit message";
          editBtn.onclick = () => startEditMessage(msg.id);
          actionsDiv.appendChild(editBtn);
        }
        // Delete button
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.title = "Delete message";
        delBtn.onclick = () => deleteMessage(msg.id);
        actionsDiv.appendChild(delBtn);
      }

      // Show history button for edited messages
      if (msg.edited && msg.history && msg.history.length > 0) {
        const histBtn = document.createElement("button");
        histBtn.textContent = "History";
        histBtn.title = "Show edit history";
        histBtn.onclick = () => showHistory(msg.history);
        actionsDiv.appendChild(histBtn);
      }

      msgDiv.appendChild(actionsDiv);

      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      messageElements[msg.id] = {element: msgDiv, msgData: msg};
    }

    function updateMessage(snapshot) {
      const msg = snapshot.val();
      msg.id = snapshot.key;
      const stored = messageElements[msg.id];
      if (!stored) return;

      stored.msgData = msg;
      const msgDiv = stored.element;

      // Reply quote
      const replyQuote = msgDiv.querySelector(".reply-quote");
      if (msg.replyTo) {
        if (!replyQuote && messageElements[msg.replyTo]) {
          const replyMsg = messageElements[msg.replyTo].msgData;
          const newQuote = document.createElement("div");
          newQuote.className = "reply-quote";
          newQuote.textContent = `↳ ${replyMsg.user}: ${reply
