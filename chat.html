<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>0PM</title>
<style>
    @keyframes rainbow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    @keyframes gold-gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    body {
        background: linear-gradient(135deg, #000000, #330033);
        font-family: Arial, sans-serif;
        color: white;
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    header {
        background: #1a1a1a;
        padding: 15px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        user-select: none;
        border-bottom: 1px solid #444;
        flex-shrink: 0;
    }
    #messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #111111;
        box-sizing: border-box;
        word-wrap: break-word;
        position: relative;
    }
    .message {
        margin: 5px 0;
        padding: 10px;
        background: rgba(255,255,255,0.05);
        border-radius: 6px;
        white-space: pre-wrap;
        position: relative;
    }
    .message .username {
        font-weight: bold;
        cursor: default;
    }
    .username-justin {
        background: linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet);
        background-size: 1400% 1400%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: rainbow 10s ease infinite;
        display: inline-block;
    }
    .username-mason {
        background: linear-gradient(270deg, black, gold, black);
        background-size: 1400% 1400%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gold-gradient 6s ease infinite;
        display: inline-block;
    }
    .username-guest {
        color: #ccc;
        font-weight: bold;
    }
    #input-area {
        display: flex;
        padding: 10px;
        background: #1a1a1a;
        border-top: 1px solid #444;
        box-sizing: border-box;
        flex-shrink: 0;
    }
    #messageInput {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        outline: none;
        font-size: 16px;
        background: #2a2a2a;
        color: white;
    }
    #sendBtn {
        margin-left: 10px;
        background: linear-gradient(90deg, #8304e0, #b367ff);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
    }
    .msg-actions {
        position: absolute;
        top: 5px;
        right: 10px;
        font-size: 14px;
        color: #bbb;
        user-select: none;
        display: none;
    }
    .message:hover .msg-actions {
        display: block;
    }
    .msg-action-btn {
        margin-left: 8px;
        cursor: pointer;
        color: #aaa;
    }
    .msg-action-btn:hover {
        color: #ff4d4d;
    }
    .reply-container {
        margin-top: 8px;
        border-left: 3px solid #555;
        padding-left: 8px;
        font-style: italic;
        color: #999;
    }
    .edit-input {
        width: 100%;
        padding: 8px;
        font-size: 16px;
        border-radius: 6px;
        border: none;
        outline: none;
        background: #333;
        color: white;
        box-sizing: border-box;
        margin-top: 5px;
        resize: vertical;
        min-height: 50px;
        max-height: 150px;
    }
    #replyIndicator {
        background: #222;
        color: #ccc;
        padding: 5px 10px;
        border-top: 1px solid #444;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    #replyIndicator button {
        background: #8304e0;
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        padding: 3px 10px;
        font-size: 14px;
    }
    #jumpToPresentBtn {
        position: fixed;
        bottom: 70px;
        right: 20px;
        background: #8304e0;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(131,4,224,0.7);
        display: none;
        user-select: none;
        z-index: 1000;
        transition: opacity 0.3s ease;
    }
    #jumpToPresentBtn:hover {
        background: #b367ff;
    }
</style>
</head>
<body>
    <header>0PM</header>
    <div id="messages"></div>
    <div id="replyIndicator" style="display:none"></div>
    <div id="input-area">
        <textarea id="messageInput" placeholder="Type a message..." autocomplete="off" rows="2"></textarea>
        <button id="sendBtn">Send</button>
    </div>
    <button id="jumpToPresentBtn" title="Jump to present">Jump to Present</button>

    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC-9Hk4TBPi4WLb4anO-84FDpIfjH8X8HY",
            authDomain: "chatting-f1958.firebaseapp.com",
            databaseURL: "https://chatting-f1958-default-rtdb.firebaseio.com",
            projectId: "chatting-f1958",
            storageBucket: "chatting-f1958.appspot.com",
            messagingSenderId: "308400029505",
            appId: "1:308400029505:web:a265599a58f1881e83abc0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const username = localStorage.getItem("chatUser");
        if (!username) {
            window.location.href = "index.html";
        }

        const messagesRef = db.ref("messages");

        // Banned words list
        const bannedWords = [
            "fuck", "fvck", "fukk", "shit", "shyt", "bitch", "b1tch", "b!tch", "asshole", "a55hole", "a$$hole",
            "dick", "d1ck", "d!ck", "pussy", "pu55y", "p*ssy", "cock", "c0ck",
            "nigger", "n1gger", "n!gger", "nigga", "n1gga", "n!gga",
            "cunt", "c*nt",
            "fag", "f4g", "f@g",
            "motherfucker", "m0therfucker",
            "twat",
            "arse", "a55",
            "slut",
            "whore",
        ];

        function censorMessage(text) {
            let censored = text;
            bannedWords.forEach(word => {
                const pattern = new RegExp(word, 'gi');
                censored = censored.replace(pattern, match => '#'.repeat(match.length));
            });
            return censored;
        }

        function formatUsername(name) {
            const lower = name.toLowerCase();
            if (lower === "justin") return `<span class="username username-justin">${name}</span>`;
            if (lower === "mason") return `<span class="username username-mason">${name}</span>`;
            if (lower === "guest") return `<span class="username username-guest">${name}</span>`;
            return `<span class="username">${name}</span>`;
        }

        let editingMessageId = null;
        let replyingToMessageId = null;

        function createMessageElement(id, msgData) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message");
            msgDiv.dataset.id = id;

            function renderContent() {
                msgDiv.innerHTML = "";

                const userSpan = document.createElement("span");
                userSpan.innerHTML = formatUsername(msgData.user) + ": ";
                msgDiv.appendChild(userSpan);

                if (editingMessageId === id) {
                    const editInput = document.createElement("textarea");
                    editInput.className = "edit-input";
                    editInput.value = msgData.text;
                    msgDiv.appendChild(editInput);
                    editInput.focus();

                    editInput.addEventListener("keydown", e => {
                        if (e.key === "Enter" && !e.shiftKey) {
                            e.preventDefault();
                            const newText = censorMessage(editInput.value.trim());
                            if (newText.length === 0) return;
                            messagesRef.child(id).update({ text: newText });
                            editingMessageId = null;
                        } else if (e.key === "Escape") {
                            editingMessageId = null;
                            renderContent();
                        }
                    });
                } else {
                    const textSpan = document.createElement("span");
                    textSpan.textContent = msgData.text;
                    msgDiv.appendChild(textSpan);

                    if (msgData.replyTo) {
                        const replyDiv = document.createElement("div");
                        replyDiv.className = "reply-container";
                        replyDiv.textContent = `â†³ Reply to: ${msgData.replyTo.user}: ${msgData.replyTo.text}`;
                        msgDiv.appendChild(replyDiv);
                    }

                    if (msgData.user === username) {
                        const actionsDiv = document.createElement("div");
                        actionsDiv.className = "msg-actions";

                        const editBtn = document.createElement("span");
                        editBtn.className = "msg-action-btn";
                        editBtn.textContent = "Edit";
                        editBtn.title = "Edit message";
                        editBtn.onclick = () => {
                            if (editingMessageId !== id) {
                                editingMessageId = id;
                                renderContent();
                            }
                        };
                        actionsDiv.appendChild(editBtn);

                        const deleteBtn = document.createElement("span");
                        deleteBtn.className = "msg-action-btn";
                        deleteBtn.textContent = "Delete";
                        deleteBtn.title = "Delete message";
                        deleteBtn.onclick = () => {
                            if (confirm("Delete this message?")) {
                                messagesRef.child(id).remove();
                            }
                        };
                        actionsDiv.appendChild(deleteBtn);

                        const replyBtn = document.createElement("span");
                        replyBtn.className = "msg-action-btn";
                        replyBtn.textContent = "Reply";
                        replyBtn.title = "Reply to message";
                        replyBtn.onclick = () => {
                            replyingToMessageId = id;
                            document.getElementById("messageInput").focus();
                            updateReplyIndicator();
                        };
                        actionsDiv.appendChild(replyBtn);

                        msgDiv.appendChild(actionsDiv);
                    }
                }
            }
            renderContent();
            return msgDiv;
        }

        function updateReplyIndicator() {
            const replyArea = document.getElementById("replyIndicator");
            if (replyingToMessageId) {
                messagesRef.child(replyingToMessageId).once("value").then(snapshot => {
                    const msg = snapshot.val();
                    if (!msg) {
                        replyingToMessageId = null;
                        updateReplyIndicator();
                        return;
                    }
                    replyArea.style.display = "flex";
                    replyArea.textContent = `Replying to ${msg.user}: ${msg.text.length > 50 ? msg.text.slice(0,50) + "..." : msg.text}`;
                    const cancelBtn = document.createElement("button");
                    cancelBtn.textContent = "Cancel";
                    cancelBtn.onclick = () => {
                        replyingToMessageId = null;
                        updateReplyIndicator();
                    };
                    replyArea.appendChild(cancelBtn);
                });
            } else {
                replyArea.style.display = "none";
                replyArea.textContent = "";
            }
        }

        function sendMessage() {
            const input = document.getElementById("messageInput");
            let text = input.value.trim();
            if (!text) return;

            text = censorMessage(text);

            const messageData = {
                user: username,
                text: text
            };

            if (replyingToMessageId) {
                messagesRef.child(replyingToMessageId).once("value").then(snapshot => {
                    const replyMsg = snapshot.val();
                    if (replyMsg) {
                        messageData.replyTo = {
                            user: replyMsg.user,
                            text: replyMsg.text
                        };
                    }
                    messagesRef.push(messageData);
                    input.value = "";
                    replyingToMessageId = null;
                    updateReplyIndicator();
                    scrollToBottom();
                });
            } else {
                messagesRef.push(messageData);
                input.value = "";
                scrollToBottom();
            }
        }

        const messagesDiv = document.getElementById("messages");
        const jumpBtn = document.getElementById("jumpToPresentBtn");

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Manage Jump to Present button visibility
        function checkScroll() {
            const nearBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop - messagesDiv.clientHeight < 50;
            if (nearBottom) {
                jumpBtn.style.display = "none";
            } else {
                jumpBtn.style.display = "block";
            }
        }

        messagesDiv.addEventListener("scroll", checkScroll);
        jumpBtn.addEventListener("click", () => {
            scrollToBottom();
            jumpBtn.style.display = "none";
            document.getElementById("messageInput").focus();
        });

        messagesRef.on("child_added", snapshot => {
            const id = snapshot.key;
            const msg = snapshot.val();
            const msgEl = createMessageElement(id, msg);
            messagesDiv.appendChild(msgEl);
            if (editingMessageId !== id) {
                // auto-scroll only if near bottom
                const nearBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop - messagesDiv.clientHeight < 100;
                if (nearBottom) {
                    scrollToBottom();
                }
            }
        });

        messagesRef.on("child_changed", snapshot => {
            const id = snapshot.key;
            const msg = snapshot.val();
            const msgEl = messagesDiv.querySelector(`[data-id="${id}"]`);
            if (msgEl) {
                const newEl = createMessageElement(id, msg);
                messagesDiv.replaceChild(newEl, msgEl);
            }
        });

        messagesRef.on("child_removed", snapshot => {
            const id = snapshot.key;
            const msgEl = messagesDiv.querySelector(`[data-id="${id}"]`);
            if (msgEl) {
                messagesDiv.removeChild(msgEl);
            }
        });

        document.getElementById("sendBtn").addEventListener("click", sendMessage);
        document.getElementById("messageInput").addEventListener("keydown", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            } else if (e.key === "Escape" && editingMessageId) {
                editingMessageId = null;
                // rerender all messages to exit edit mode
                messagesDiv.querySelectorAll(".message").forEach(msgEl => {
                    const id = msgEl.dataset.id;
                    messagesRef.child(id).once("value").then(snapshot => {
                        const msg = snapshot.val();
                        if (msg) {
                            const newEl = createMessageElement(id, msg);
                            messagesDiv.replaceChild(newEl, msgEl);
                        }
                    });
                });
            }
        });

        // Initial scroll to bottom on load
        window.onload = () => {
            setTimeout(scrollToBottom, 100);
            updateReplyIndicator();
        };
    </script>
</body>
</html>
